<!DOCTYPE html>
<html lang="en">
<head>
    <script src="trackPlayerInputs.js" defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <title>Thumbsup</title>
    <style>
        /* Reset some default styles */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        /* Flexbox styles to center content */
        body {
            display: flex;
            justify-content: center;  /* Center horizontally */
            margin-top: 300px;
            height: 100vh;            /* Full viewport height */
            font-family: Arial, sans-serif;
        }

        #time-elapsed {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 18px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
        }
        #reward-display {
    font-size: 50px; /* Adjust the size as needed */
}
    </style>
</head>

<body>
    

    <div class="center-content">
        <strong><h1 id="reward-display">Loading...</h1></strong> <!-- Default text while loading -->
    </div>

    <script>
        let countdownValue = 3;
        let countdownInterval;

        // On page load, get the score, lines, iterationCount, and loopCount from URL params
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const score = urlParams.get('score');
            const lines = urlParams.get('lines');
            const iterationCount = parseInt(urlParams.get('iteration')) || 0;
            const loopCount = parseInt(urlParams.get('loopCount')) || 0;

            // Calculate reward percentage based on score
            //if (score !== null) {
                //let rewardPercentage = (parseInt(score) / (40 + parseInt(score))) * 100; 
                //rewardPercentage = Math.min(rewardPercentage, 100);  // Ensure a max of 100%
                //document.getElementById("reward-display").textContent = `${rewardPercentage.toFixed(2)}%`;
            //} else {
                //document.getElementById("reward-display").textContent = "0%";
            //}





// Define the array with the dynamic values for each loop
const dynamicValues = [40, 20, 20, 300, 20, 110, 30, 30];  // Values for each of the 8 loops

// Get the dynamic value based on the current loop count (adjusting for zero-based index)
let dynamicValue = dynamicValues[loopCount - 1];  // loopCount - 1 because arrays are zero-based

if (score !== null) {
    // Define an array of possible formulas
    const formulas = [
        (score) => (parseInt(score) / (dynamicValue + parseInt(score))) * 100,  // Original formula with dynamic value
        (score) => (parseInt(score) * 2) / 100,  // A new random formula (scaled version)
        (score) => Math.pow(parseInt(score), 1.5) % 100,  // Another variation: powered formula
        (score) => 100 - Math.log(parseInt(score) + 1) * 10,  // Another randomized formula using logarithm
        (score) => (parseInt(score) * 5) % 120  // A modulo-based formula
    ];

    // Select a random formula from the list
    const randomFormula = formulas[Math.floor(Math.random() * formulas.length)];

    // Calculate the reward percentage using the selected formula
    let rewardPercentage = randomFormula(score);

    // Ensure the result is within the 0-100% range
    rewardPercentage = Math.min(Math.max(rewardPercentage, 0), 100);

    // Display the result
    document.getElementById("reward-display").textContent = `${rewardPercentage.toFixed(2)}%`;
} else {
    document.getElementById("reward-display").textContent = "0%";
}


            // Start countdown and timer
            startCountdown(iterationCount, score, lines, loopCount);
            startTimer();
        };

        // Function to track and display elapsed time across pages
        function startTimer() {
            let elapsedTime = parseInt(localStorage.getItem('elapsedTime')) || 0;
            const timeElapsedElement = document.getElementById('time-elapsed');

            const updateElapsedTime = () => {
                elapsedTime++;  
                timeElapsedElement.textContent = `Elapsed Time: ${elapsedTime}s`;
                localStorage.setItem('elapsedTime', elapsedTime);
            };

            updateElapsedTime();
            setInterval(updateElapsedTime, 1000);
        }

        // Function to handle countdown and redirect after time expires
        function startCountdown(iterationCount, score, lines, loopCount) {
            // Skip showing countdown text since we don't want it displayed

            countdownInterval = setInterval(() => {
                countdownValue--;  

                if (countdownValue <= 0) {
                    clearInterval(countdownInterval);  // Stop the countdown
                    console.log("Redirecting to rate.html");

                    // Redirect to rate.html with the iterationCount incremented
                    window.location.href = `rate.html?iteration=${iterationCount}&loopCount=${loopCount}&score=${score}&lines=${lines}`;
                }
            }, 1000);  
        }
    </script>

</body>
</html>